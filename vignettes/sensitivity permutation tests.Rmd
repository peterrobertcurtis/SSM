---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
library(SSM)
```

A permutation test for sensitivity. A toy example. We start with a design, 
specifically a lattice on \eqn{[-1, 1]^2} with some simulated responses from a function with both main effects and interactions. We fit
an SSM to this data, computing Sobol' indices too.

```{r}
f <- function(x)
  2*x[1] + 4 * cos(x[1] * x[2]) + x[2]^3
X <- as.matrix(expand.grid(c(-1, 0, 1), c(-1, 0, 1)))
Y <- apply(X, 1, f)
s <- fit.ssm(X, Y, SA = TRUE)
s
```

The FANOVA variances are

```{r}
# total variance
s@total_variance
# main effects
s@main_sobol
# second order interaction
s@int_sobol

```

We compute the Q matrices associated with the FANOVA decomposition, with which 
we can reconstruct the FANOVA variances.

```{r}
Q <- constructQ(s, 0)
Q1  <- constructQ(s, 1)
Q2  <- constructQ(s, 2)
Q12 <- constructQ(s, c(1, 2))
t(Y) %*% Q %*% Y
t(Y) %*% Q1 %*% Y / t(Y) %*% Q %*% Y
t(Y) %*% Q2 %*% Y / t(Y) %*% Q %*% Y
t(Y) %*% Q12 %*% Y / t(Y) %*% Q %*% Y
```

We test the null hypotheses that the main effects are present using permutation tests on the appropriate quadratic forms.  We start with the null hypothesis \eqn{H_0:S_1\neq 0}.  Under the null hypothesis the labels for \eqn{x_1} are not exchangable, but those of \eqn{x_2} are.  For the main effect of x1 we 
only use permutations that only permute x1. There are four of these: (1 2 3 4),
(3 2 1 4), (3 4 1 2), (1 4 3 2).

```{r}
t(Y) %*% Q1 %*% Y / t(Y) %*% Q %*% Y
t(Y[c(3, 2, 1, 4)]) %*% Q1 %*% Y[c(3, 2, 1, 4)] / t(Y[c(3, 2, 1, 4)]) %*% Q %*% Y[c(3, 2, 1, 4)]
t(Y[c(3, 4 , 1, 2)]) %*% Q1 %*% Y[c(3, 4 , 1, 2)] / t(Y[c(3, 4 , 1, 2)]) %*% Q %*% Y[c(3, 4 , 1, 2)]
t(Y[c(1, 4, 3, 2)]) %*% Q1 %*% Y[c(1, 4, 3, 2)] / t(Y[c(1, 4, 3, 2)]) %*% Q %*% Y[c(1, 4, 3, 2)]
```

The null hypothesis is that the true value of S1 is zero.  To compute the power we simulate using responses where S1 is non-zero.  For example
```{r}
f <- function(x) 1 + x[2] + x[1]*x[2] + x[1]
simY <- apply(X, 1, f)
t(simY) %*% Q1 %*% simY / t(simY) %*% Q %*% simY
t(simY[c(2, 1, 3, 4)]) %*% Q1 %*% simY[c(2, 1, 3, 4)]/ t(simY[c(2, 1, 3, 4)]) %*% Q %*% simY[c(2, 1, 3, 4)]
t(simY[c(1, 2, 4, 3)]) %*% Q2 %*% simY[c(1, 2, 4, 3)]/ t(simY[c(1, 2, 4, 3)]) %*% Q %*% simY[c(1, 2, 4, 3)]
t(simY[c(2, 1, 4, 3)]) %*% Q12 %*% simY[c(2, 1, 4, 3)] / t(simY[c(2, 1, 4, 3)]) %*% Q %*% simY[c(2, 1, 4, 3)]
```

